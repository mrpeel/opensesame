function prepServiceWorker(){if(navigator.serviceWorker){navigator.serviceWorker.register("sw.js").then(function(reg){if(navigator.serviceWorker.controller)return reg.waiting?void updateReady(reg.waiting):reg.installing?void trackInstalling(reg.installing):void reg.addEventListener("updatefound",function(){trackInstalling(reg.installing)})});let refreshing;navigator.serviceWorker.addEventListener("controllerchange",function(){refreshing||(window.location.reload(),refreshing=!0)})}}function trackInstalling(worker){worker.addEventListener("statechange",function(){"installed"==worker.state&&updateReady(worker)})}function updateReady(worker){let countdownDiv=document.getElementById("update-message"),countdownValue=document.getElementById("count-down-value"),cdVals=[5,4,3,2,1];countdownDiv.classList.remove("hidden"),window.setTimeout(function(){worker.postMessage({action:"skipWaiting"})},5e3),cdVals.forEach(function(val){window.setTimeout(function(){countdownValue.innerText=val},1e3*(5-val))})}function firebaseDataCallback(firebaseDomainValues){let domainString=JSON.stringify(firebaseDomainValues).replace(/--dot--/g,".");domainValues=JSON.parse(domainString),console.log(domainValues),""!==domainName.value&&setDomainUserNames(openSesame.prepareDomain(domainName.value))}function setDomainUserNames(domain){if(clearUserNames(),domainValues&&domainValues[domain]&&domainValues[domain].usernames){let domainUsers=domainValues[domain].usernames,userNames=[],mostRecentTimeStamp=0,mostRecentUserName="";Object.keys(domainUsers).forEach(function(domainUser){0===domainUser.indexOf(domainUser)&&userNames.push(domainUser);let passwordTypeVals=domainValues[domain].usernames[domainUser];Object.keys(passwordTypeVals).forEach(function(passwordType){passwordTypeVals[passwordType].lastUsed>mostRecentTimeStamp&&(mostRecentTimeStamp=passwordTypeVals[passwordType].lastUsed,mostRecentUserName=domainUser)})}),""!==mostRecentUserName&&populateValue(userName,mostRecentUserName),loadUserNames(userNames),""!==userName.value&&userNameUpdate()}else setType("long-password"),version.value=1}function setUserNamePasswordTypes(domain,userName){if(resetPasswordTypesUsed(),domainValues&&domainValues[domain]&&domainValues[domain].usernames[userName]){let passwordTypeVals=domainValues[domain].usernames[userName],mostRecentTimeStamp=0,mostRecentPasswordType="";Object.keys(passwordTypeVals).forEach(function(passwordType){let typeReference=document.getElementById(passwordType),typeTooltip=document.getElementById(passwordType+"-tooltip");typeReference&&(typeReference.classList.add("green-text"),typeTooltip.classList.remove("hidden"),passwordTypeVals[passwordType].lastUsed>mostRecentTimeStamp&&(mostRecentTimeStamp=passwordTypeVals[passwordType].lastUsed,typeTooltip.innerText=relativeDate(passwordTypeVals[passwordType].lastUsed),mostRecentPasswordType=passwordType))}),""!==mostRecentPasswordType&&setType(mostRecentPasswordType)}else setType("long-password"),version.value=1}function setUserNamePasswordTypeVersion(domain,userName,passwordType){if(domainValues&&domainValues[domain]&&domainValues[domain].usernames[userName]){let passwordTypeVals=domainValues[domain].usernames[userName];Object.keys(passwordTypeVals).forEach(function(passwordTypeKey){if(passwordTypeKey===passwordType&&passwordTypeVals[passwordTypeKey].passwordVersion)return void(version.value=passwordTypeVals[passwordTypeKey].passwordVersion)})}else version.value=1}function resetPasswordTypesUsed(){for(let lCounter=0;lCounter<type.children.length;lCounter++)"LI"===type.children[lCounter].nodeName?type.children[lCounter].classList.remove("green-text"):type.children[lCounter].classList.add("hidden")}function recordGeneration(domain,userName,passwordType,passwordVersion){let userId=fbAuth.getUserId(),domainValue=domain.replace(".","--dot--");userId&&firebase.database().ref("users/"+userId+"/domains/"+domainValue+"/usernames/"+userName+"/"+passwordType).update({passwordVersion:passwordVersion,lastUsed:Date.now()})}function populateValue(pElement,pValue){pElement.value=pValue,pValue.length>0&&pElement.parentElement.classList.add("is-dirty")}function closeDialog(){let dialog=document.getElementById("confirm-dialog");clearPassPhraseAndStore(),dialog.classList.add("hidden")}function checkVersion(){let versionVal=version.value;versionVal=versionVal.replace(/[^0-9]/g,""),""===versionVal?(populateValue(version,"1"),versionVal="1"):versionVal.length>3&&(versionVal=versionVal.substring(0,3)),populateValue(version,versionVal),version.parentElement.classList.remove("is-invalid")}function userNameUpdate(){""!==domainName.value&&""!==userName.value&&setUserNamePasswordTypes(domainName.value,userName.value)}function checkRequired(currentElement){let stopPosition=-1;currentElement&&(stopPosition=requiredElements.indexOf(currentElement)),stopPosition==-1&&(stopPosition=requiredElements.length);for(let elCounter=0;elCounter<stopPosition;elCounter++){let element=document.getElementById(requiredElements[elCounter]);element&&(element.value&&""!==element.value?element.parentElement.classList.remove("is-invalid"):element.parentElement.classList.add("is-invalid"))}}function sendValsToExt(){isChromeExtension&&storeExtVals()}function openCloseOptions(){}function clearPassword(){hideElement("password-card"),password&&(password.textContent=zeroVar(password.textContent),password.textContent="")}function clearPassPhraseStore(){temporaryPhraseStore.clearStore(),isChromeExtension&&clearExtPhrase(),lastPassGenTimeStamp=Date.now()}function clearPassPhrase(){passPhrase&&(passPhrase.value=zeroVar(passPhrase.value),passPhrase.value=""),clearPassword()}function clearPassPhraseAndStore(){clearPassPhrase(),clearPassPhraseStore(),setPassPhraseScreenState("editing"),passPhrase.focus()}function setPassPhrase(passPhraseValue){passPhrase.value=passPhraseValue,setPassPhraseScreenState("holding"),passPhraseTimedClear()}function passPhraseTimedClear(){let thisPasswordTimeStamp;lastPassGenTimeStamp=Date.now(),thisPasswordTimeStamp=lastPassGenTimeStamp,window.setTimeout(function(){thisPasswordTimeStamp===lastPassGenTimeStamp&&(clearPassPhrase(),setPassPhraseScreenState("stored"))},3e5)}function passPhraseUpdated(){passPhrase.value.length>0&&userName.value.length>0?temporaryPhraseStore.encryptPhrase(passPhrase.value,userName.value.trim()).then(function(val){sendValsToExt()}).catch(function(err){console.log(err)}):(temporaryPhraseStore.clearStore(),sendValsToExt())}function generatePassword(){let password=document.getElementById("password"),error=document.getElementById("error");if(hidePassPhraseDisplayButton(),optionsVisible&&openCloseOptions(),hideElement("copy-password-div"),isReadyToGenerate()){showElement("password-card"),error.textContent=password.textContent="";let gPassPhrase=passPhrase.value,gDomainName=domainName.value.trim(),gUserName=userName.value.trim(),gSecurityQuestion="",gVersion=version.value;"answer"===passwordType&&securityQuestion.value.trim().length>0&&(gSecurityQuestion=securityQuestion.value.trim()),passwordType&&openSesame.generatePassword(gUserName,gPassPhrase,gDomainName,passwordType,gVersion,gSecurityQuestion).then(function(passwordValue){clearBodyClasses(),"answer"===passwordType?bodyNode.classList.add("ext-answer-generated"):bodyNode.classList.add("ext-pass-generated"),password.textContent=passwordValue,populateOrCopyPassword(),passPhraseTimedClear(),setPassPhraseScreenState("holding"),window.setTimeout(function(){recordGeneration(gDomainName,gUserName,passwordType,gVersion),clearPassword()},3e4)}).catch(function(err){error.textContent=err.message})}}function populateOrCopyPassword(){let executePasswordCopy=!1;isChromeExtension?(generateExtPassword(),extHasPassword!==!0||"login"===passwordType||"answer"===passwordType?executePasswordCopy=!0:window.setTimeout(function(){showSnackbar(successPrefix+" inserted",5,!1)},250)):executePasswordCopy=!0,executePasswordCopy&&(showElement("copy-password-div"),password.scrollIntoView(),window.setTimeout(function(){copyPasswordToClipboard()},500))}function setPassPhraseScreenState(passState){passPhraseState=passState,"editing"===passState?(showElement("passphrase-div"),hideElement("confirm-dialog"),hideElement("clear-passphrase")):"holding"===passState?(showElement("passphrase-div"),hideElement("confirm-dialog")):"stored"===passState?(showElement("confirm-dialog"),window.setTimeout(function(){document.getElementById("confirm-passphrase").focus()})):"failed"===passState&&(hideElement("confirm-dialog"),showElement("passphrase-div"),showSnackbar("The entered characters don't match your pass phrase. Pass phrase cleared.",5,!0),window.setTimeout(function(){setPassPhraseScreenState("editing"),passPhrase.focus()},5250))}function checkConfirmation(){let confirmPassPhrase=document.getElementById("confirm-passphrase");3===confirmPassPhrase.value.length&&(confirmThreeChars(confirmPassPhrase.value,userName.value.trim()),zeroVar(confirmPassPhrase.value),confirmPassPhrase.value="")}function confirmThreeChars(threeChars,userName){temporaryPhraseStore.decryptPhrase(threeChars,userName).then(function(plainText){setPassPhrase(plainText),setPassPhraseScreenState("holding")}).catch(function(err){clearPassPhraseStore(),clearPassPhrase(),setPassPhraseScreenState("failed")})}function isReadyToGenerate(){checkRequired();let calculatedDomainName=openSesame.prepareDomain(domainName.value);return userName.value.trim().length>0&&passPhrase.value.trim().length>0&&calculatedDomainName.length>0&&("answer"!==passwordType||securityQuestion.value.trim().length>0)}function trimDomainName(){domainName.value=openSesame.prepareDomain(domainName.value),""!==domainName.value&&setDomainUserNames(domainName.value)}function showElement(elementName){let element=document.getElementById(elementName);element&&element.classList.remove("hidden")}function hideElement(elementName){let element=document.getElementById(elementName);element&&element.classList.add("hidden")}function clearBodyClasses(){bodyNode.classList.remove("ext-pass"),bodyNode.classList.remove("ext-answer"),bodyNode.classList.remove("ext-pass-generated"),bodyNode.classList.remove("ext-answer-generated")}function copyPasswordToClipboard(){let clipboardVal=document.getElementById("clipboard-value");clipboardVal.value=password.textContent,clipboardVal.select();try{document.execCommand("copy")&&showSnackbar(successPrefix+" copied to Clipboard",5,!1)}catch(err){hideElement("copy-password-div"),console.log("Copy command failed")}}function chooseType(){setType(this.id)}function setType(passwordSelection){let generatePasswordButton=document.getElementById("generate-password"),copyPasswordButton=document.getElementById("copy-password"),passwordCardHeader=document.getElementById("password-card-header"),passwordText=document.getElementById("password-type-text");copyPasswordButton.textContent="Copy Password",successPrefix="Password",passwordCardHeader.textContent="Password",generatePasswordButton.textContent="Produce password",showElement("user-name-div"),hideElement("security-question-div"),passwordType=passwordSelection,setUserNamePasswordTypeVersion(domain.value,userName.value,passwordSelection);let passwordLabel=document.getElementById("password-selected");switch(passwordSelection){case"maximum-password":passwordDescription="Maximum password",passwordText.innerText="Maximum password (20 characters)";break;case"long-password":passwordDescription="Long password",passwordText.innerText="Long password (14 characters)";break;case"medium-password":passwordDescription="Medium password",passwordText.innerText="Medium password (8 characters)";break;case"basic-password":passwordDescription="Basic password",passwordText.innerText="Basic password (8 letters / numbers)";break;case"short-password":passwordDescription="Short password",passwordText.innerText="Short password (6 letters / numbers)";break;case"pin":generatePasswordButton.textContent="Produce PIN",passwordDescription="Four digit PIN",copyPasswordButton.textContent="Copy PIN",successPrefix="PIN",passwordCardHeader.textContent="PIN",passwordText.innerText="Four digit PIN";break;case"pin-6":generatePasswordButton.textContent="Produce PIN",passwordDescription="Six digit PIN",copyPasswordButton.textContent="Copy PIN",successPrefix="PIN",passwordCardHeader.textContent="PIN",passwordText.innerText="Six digit PIN";break;case"answer":generatePasswordButton.textContent="Produce security answer",passwordDescription="Security answer",copyPasswordButton.textContent="Copy Security Answer",successPrefix="Answer",passwordCardHeader.textContent="Answer",showElement("security-question-div"),passwordText.innerText="Security answer"}passwordLabel.parentElement.classList.add("is-dirty"),clearBodyClasses(),"answer"===passwordType?bodyNode.classList.add("ext-answer"):bodyNode.classList.add("ext-pass"),clearPassword()}function clearUserNames(){let userNames=document.getElementById("loaded-usernames");for(;userNames.firstChild;)userNames.removeChild(userNames.firstChild);userNameDropDown.classList.add("hidden")}function loadUserNames(names){if(names.length){let userNames=document.getElementById("loaded-usernames");names.forEach(function(name){let nameItem=document.createElement("li");nameItem.appendChild(document.createTextNode(name)),nameItem.setAttribute("id",name),nameItem.classList.add("mdl-menu__item","menu-dropdown"),userNames.appendChild(nameItem),nameItem.addEventListener("click",chooseName,!1)}),userNameDropDown.classList.remove("hidden")}""===userName.value&&populateValue(userName,names[0])}function chooseName(){setUserName(this.id)}function setUserName(name){let userNames=document.getElementById("loaded-usernames");populateValue(userName,name),passPhrase.focus(),userNames.MaterialMenu.hide(),userNameUpdate()}function showPassPhraseDisplayButton(){"editing"===passPhraseState||"failed"===passPhraseState?showElement("show-passphrase"):"holding"===passPhraseState&&showElement("clear-passphrase")}function hidePassPhraseDisplayButton(){hideElement("show-passphrase"),hideElement("clear-passphrase"),passPhrase.type="password"}function togglePassPhraseView(){let passPhraseDisplayButton=document.getElementById("show-passphrase");"password"===passPhrase.type?(passPhrase.type="text-area",passPhraseDisplayButton.innerHTML='<i class="material-icons">visibility_off</i>'):(passPhrase.type="password",passPhraseDisplayButton.innerHTML='<i class="material-icons">visibility</i>'),passPhrase.focus()}function runTests(){isChromeExtension?window.open("https://mrpeel.github.io/opensesame/test/opensesame-test.html"):window.open("test/opensesame-test.html")}function showSnackbar(message,numberSeconds,isError){let notification=document.getElementById("open-sesame-snackbar"),data={message:message,timeout:1e3*numberSeconds};notification.MaterialSnackbar.showSnackbar(data);let snackbarText=document.getElementById("open-sesame-snackbar-text");isError?snackbarText.classList.add("snackbar-error"):snackbarText.classList.remove("snackbar-error")}function setPassChangeRequired(){let thisPasswordTimeStamp;passChangeRequiredCount=2,lastPassPhraseLength=passPhrase.value.length,lastPassGenTimeStamp=Date.now(),thisPasswordTimeStamp=lastPassGenTimeStamp,window.setTimeout(function(){thisPasswordTimeStamp===lastPassGenTimeStamp&&clearPassPhrase()},18e4)}function changePassPhrase(){clearPassword(),showPassPhraseDisplayButton()}function relativeDate(timestamp){let date=new Date(timestamp),nowDate=new Date,diff=(nowDate.getTime()-date.getTime())/1e3,dayDiff=Math.floor(diff/86400);0===dayDiff&&nowDate.getDate()-date.getDate()>0&&(dayDiff=1);let yearDiff=Math.floor(dayDiff/334),year=date.getFullYear(),monthDesc=["January","February","March","Aprail","May","June","July","August","September","October","November","December"];return isNaN(dayDiff)||dayDiff<0||dayDiff>31?yearDiff>0?monthDesc[date.getMonth()]+" "+year:"last "+monthDesc[date.getMonth()]:0==dayDiff&&diff<60?"just now":0==dayDiff&&diff<120?"a minute ago":0==dayDiff&&diff<3600?Math.floor(diff/60)+" minutes ago":0==dayDiff&&diff<7200?"an hour ago":0==dayDiff?Math.floor(diff/7200)+" hours ago":1==dayDiff?"yesterday":dayDiff<7?dayDiff+" days ago":dayDiff>=7&&dayDiff<10?"a week ago":dayDiff<=31?Math.ceil(dayDiff/7)+" weeks ago":void 0}window.prepServiceWorker=prepServiceWorker,window.changePassPhrase=changePassPhrase,window.setPassChangeRequired=setPassChangeRequired;let passPhrase,domainName,securityQuestion,userName,userNameDropDown,type,version,bodyNode,password,isChromeExtension,optionsVisible=!1,requiredElements=["domain","user-name","passphrase"];const openSesame=new OpenSesame,temporaryPhraseStore=new TemporaryPhraseStore,fbAuth=new FBAuth(firebaseDataCallback,firebaseDataCallback);let passwordType,domainValues,lastPassGenTimeStamp,successPrefix,passPhraseState;window.addEventListener("load",function(){window.applicationCache.addEventListener("updateready",function(e){window.applicationCache.status==window.applicationCache.UPDATEREADY&&window.location.reload()},!1),domainName=document.getElementById("domain"),userName=document.getElementById("user-name"),userNameDropDown=document.getElementById("username-dropdown"),passPhrase=document.getElementById("passphrase"),securityQuestion=document.getElementById("security-question"),type=document.getElementById("type"),bodyNode=document.querySelector("body"),password=document.getElementById("password"),version=document.getElementById("version"),domainName.addEventListener("input",function(){checkRequired("domain"),clearPassword()},!1),userName.addEventListener("input",function(){checkRequired("user-name"),clearPassword()},!1),passPhrase.addEventListener("input",function(){checkRequired("passphrase"),clearPassword()},!1),securityQuestion.addEventListener("input",function(){checkRequired(),clearPassword()},!1),version.addEventListener("input",function(){checkRequired(),clearPassword()},!1),version.addEventListener("blur",checkVersion,!1),passPhrase.addEventListener("focus",showPassPhraseDisplayButton,!1),passPhrase.addEventListener("blur",passPhraseUpdated,!1),document.getElementById("confirm-passphrase").addEventListener("input",checkConfirmation,!1),userName.addEventListener("focus",hidePassPhraseDisplayButton,!1),userName.addEventListener("blur",function(){userNameUpdate(),sendValsToExt()},!1),domainName.addEventListener("focus",hidePassPhraseDisplayButton,!1),domainName.addEventListener("blur",function(){trimDomainName(),sendValsToExt()},!1),securityQuestion.addEventListener("focus",hidePassPhraseDisplayButton,!1),securityQuestion.addEventListener("blur",sendValsToExt,!1);for(let lCounter=0;lCounter<type.children.length;lCounter++)"LI"===type.children[lCounter].nodeName&&type.children[lCounter].addEventListener("click",chooseType,!1);document.getElementById("header-key").addEventListener("click",runTests,!1),document.getElementById("clear-passphrase").addEventListener("click",clearPassPhraseAndStore,!1),document.getElementById("show-passphrase").addEventListener("click",togglePassPhraseView,!1),document.getElementById("generate-password").addEventListener("click",generatePassword,!1),document.getElementById("copy-password").addEventListener("click",copyPasswordToClipboard,!1),document.getElementById("close-password").addEventListener("click",clearPassword,!1),document.getElementById("clear-close-dialog").addEventListener("click",closeDialog,!1),document.getElementById("close-password-confirm").addEventListener("click",closeDialog,!1),domainName.disabled=!1,userName.disabled=!1,passPhrase.disabled=!1,type.disabled=!1,""===domainName.value.trim()?domainName.focus():userName.focus(),void 0===passPhraseState&&setPassPhraseScreenState("editing"),void 0===passwordType&&window.setTimeout(function(){setType("long-password")})},!1);